/* =========================
   SHUFFLE (FIXED): shuffle happens ONLY when you ask for it
   ========================= */
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Keep a persistent deck order so flip never changes the pairing
let baseDeck = [...ALL_CARDS];   // (Top 100 already sliced)
let deckOrder = [...baseDeck];   // this is what we display (may be shuffled)
let activeDeck = [];             // filtered view (unknown-only)

// Call this only when shuffle settings change
function applyShuffleIfNeeded() {
  deckOrder = shuffleOn ? shuffleArray(baseDeck) : [...baseDeck];
}

// Call this whenever unknown-only mode changes OR unknown set changes
function applyFilter() {
  activeDeck = reviewUnknownOnly
    ? deckOrder.filter(c => unknownSet.has(cardKey(c)))
    : [...deckOrder];

  if (index >= activeDeck.length) index = 0;
}

/* =========================
   QUEST AUDIO: disable autospeak if TTS not supported
   ========================= */
function ttsSupported() {
  try {
    return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
  } catch {
    return false;
  }
}

// If Quest/browser has no TTS, disable autospeak automatically
if (!ttsSupported()) {
  autoSpeakOn = false;
  localStorage.setItem(LS_AUTOSPEAK, "0");
}

/* =========================
   SPEECH (ONLY speaks current side; never changes card)
   ========================= */
function speak(text, lang) {
  if (!autoSpeakOn) return;
  if (!audioUnlocked) return;
  if (!ttsSupported()) return;

  try {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = 0.95;
    window.speechSynthesis.speak(u);
  } catch {}
}

function speakCurrent() {
  const c = currentCard();
  if (!c) return;
  const text = showingSpanish ? c.es : c.en;
  speak(text, showingSpanish ? "es-ES" : "en-US");
}

/* =========================
   RENDER (IMPORTANT: no reshuffle here)
   ========================= */
function currentCard() {
  if (!activeDeck.length) return null;
  return activeDeck[index];
}

function updateStatus() {
  statusEl.textContent =
    `Top 100 · Card ${activeDeck.length ? (index + 1) : 0}/${activeDeck.length} · ` +
    `Unknown: ${unknownSet.size} · Mode: ${reviewUnknownOnly ? "Unknown only" : "All"} · ` +
    `Shuffle: ${shuffleOn ? "ON" : "OFF"} · ` +
    `Audio: ${ttsSupported() ? (audioUnlocked ? "Unlocked" : "Tap Enable Audio") : "Not supported on this browser"}`;
}

function render() {
  // only filter; do NOT reshuffle or rebuild order
  applyFilter();

  if (!activeDeck.length) {
    wordEl.textContent = reviewUnknownOnly ? "No unknown cards" : "No cards";
    subEl.textContent = reviewUnknownOnly
      ? "Press R to exit Unknown mode or mark cards with U."
      : "";
    badgeEl.textContent = reviewUnknownOnly ? "Unknown only" : "EN/ES";
    updateStatus();
    return;
  }

  const c = currentCard();
  const isUnknown = unknownSet.has(cardKey(c));

  wordEl.textContent = showingSpanish ? c.es : c.en;
  subEl.textContent = showingSpanish ? "Spanish" : "English";
  badgeEl.textContent = isUnknown ? "UNKNOWN" : `${startSide} start`;

  updateStatus();

  // Auto speak the side that is currently showing
  speakCurrent();
}

/* =========================
   ACTIONS (never reshuffle inside flip/next/prev)
   ========================= */
function flip() {
  showingSpanish = !showingSpanish; // same card, other side
  render();
}

function nextCard() {
  if (!activeDeck.length) return;
  index = (index + 1) % activeDeck.length;
  showingSpanish = (startSide === "ES"); // reset to chosen start side
  render();
}

function prevCard() {
  if (!activeDeck.length) return;
  index = (index - 1 + activeDeck.length) % activeDeck.length;
  showingSpanish = (startSide === "ES");
  render();
}

function toggleShuffle() {
  shuffleOn = !shuffleOn;
  localStorage.setItem(LS_SHUFFLE, shuffleOn ? "1" : "0");
  index = 0;
  showingSpanish = (startSide === "ES");
  applyShuffleIfNeeded(); // shuffle ONCE here
  render();
}

function reshuffleNow() {
  shuffleOn = true;
  localStorage.setItem(LS_SHUFFLE, "1");
  index = 0;
  showingSpanish = (startSide === "ES");
  applyShuffleIfNeeded(); // shuffle ONCE here
  render();
}

/* =========================
   INIT (do once)
   ========================= */
applyShuffleIfNeeded();
applyFilter();
render();
